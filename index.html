<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ข้อมูลการเข้ารับทุนการศึกษา</title>

  <!-- Google Font: Kanit -->
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    html, body { font-family: 'Kanit', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { pastel: { card: 'rgba(255,255,255,0.85)' } },
          boxShadow: { soft: '0 10px 30px rgba(31,41,55,.15)' }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-gradient-to-br from-indigo-500 via-sky-400 to-purple-500">

  <!-- Top language toggle -->
  <div class="absolute top-4 right-4 z-50">
    <div class="flex items-center gap-2 bg-white/70 backdrop-blur-md rounded-full border border-white/60 px-2 py-1 shadow">
      <button id="btnTH" class="px-3 py-1 rounded-full text-sm font-medium text-indigo-900 hover:bg-indigo-100 focus:outline-none">TH</button>
      <button id="btnEN" class="px-3 py-1 rounded-full text-sm font-medium text-indigo-900 hover:bg-indigo-100 focus:outline-none">EN</button>
    </div>
  </div>

  <!-- Page Wrapper -->
  <div class="min-h-screen flex items-center justify-center p-4">
    <!-- Card -->
    <div class="w-full max-w-2xl">
      <div class="backdrop-blur-md bg-pastel-card rounded-3xl shadow-soft border border-white/40">
        <!-- Header -->
        <div class="rounded-t-3xl p-8 text-center">
          <!-- Small Logo -->
          <img
            src="https://drive.google.com/uc?export=view&id=12gLdwUb7VG5mAwanS2yNIcaydtL4U7vN"
            alt="Organization Logo"
            class="h-12 sm:h-14 mx-auto mb-3 opacity-95"
            loading="lazy"
          />
          <h1 id="title" class="text-3xl sm:text-4xl md:text-5xl font-semibold text-indigo-900 drop-shadow-sm">
            ข้อมูลการเข้ารับทุนการศึกษา
          </h1>
          <p id="subtitle" class="mt-3 text-indigo-800/80 text-sm sm:text-base">
            ค้นหาด้วยรหัสนักศึกษา
          </p>
        </div>

        <!-- Divider -->
        <div class="h-[2px] bg-gradient-to-r from-white/0 via-white/70 to-white/0"></div>

        <!-- Search Area -->
        <div class="p-6 sm:p-8">
          <div class="grid gap-4 sm:gap-5">
            <label for="studentId" id="labelStudentId" class="text-indigo-900 font-medium">รหัสนักศึกษา</label>
            <div class="flex flex-col sm:flex-row gap-3">
              <input
                id="studentId"
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                maxlength="8"
                placeholder="เช่น 68123456"
                class="w-full rounded-2xl border border-indigo-300/60 bg-white/70 focus:bg-white px-4 py-3 outline-none focus:ring-4 ring-indigo-300 placeholder-indigo-300"
                aria-describedby="status"
              />
              <button
                id="searchBtn"
                class="whitespace-nowrap rounded-2xl px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-medium shadow hover:shadow-lg transition active:scale-[0.99] disabled:opacity-60 disabled:cursor-not-allowed"
              >
                ค้นหา
              </button>
            </div>

            <!-- Status / Error line -->
            <div id="status" class="min-h-[1.5rem] text-sm text-indigo-900/80"></div>

            <!-- Tips -->
            <div id="note" class="text-xs text-indigo-900/70">
              หมายเหตุ: หากไม่พบข้อมูล ระบบจะแจ้ง “ไม่พบข้อมูล กรุณาติดต่อเจ้าหน้าที่”
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div id="footer" class="text-center text-white/90 text-xs sm:text-sm mt-4">
        พัฒนาโดย ส่วนส่งเสริมและพัฒนานักศึกษา
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="resultModal" class="fixed inset-0 z-40 hidden items-center justify-center p-4" aria-hidden="true">
    <!-- Backdrop -->
    <div id="modalBackdrop" class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

    <!-- Modal Card -->
    <div class="relative z-10 w-full max-w-lg rounded-3xl bg-white shadow-2xl border border-indigo-100 overflow-hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="h-2 bg-gradient-to-r from-indigo-600 to-purple-600"></div>

      <div class="p-6 sm:p-8">
        <div class="flex items-start justify-between">
          <h2 id="modalTitle" class="text-xl sm:text-2xl font-semibold text-indigo-900">ผลการค้นหา</h2>
        </div>

        <div class="mt-5 grid gap-4">
          <!-- Seat Number -->
          <div class="text-center">
            <div id="labelSeat" class="text-indigo-700/80 text-sm">เลขที่นั่ง</div>
            <div id="seatNumber" class="mt-1 text-4xl sm:text-5xl md:text-6xl font-bold text-indigo-900 tracking-wide"></div>
          </div>

          <div class="grid gap-2 text-indigo-900/90">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
              <span id="labelStudentIdModal" class="font-medium text-indigo-700">รหัสนักศึกษา</span>
              <span id="studentIdDisplay" class="text-indigo-900"></span>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
              <span id="labelFullName" class="font-medium text-indigo-700">ชื่อ-สกุล</span>
              <span id="fullName" class="text-indigo-900"></span>
            </div>

            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
              <span id="labelScholarship" class="font-medium text-indigo-700">ชื่อทุน</span>
              <span id="scholarshipName" class="text-indigo-900"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Close Button (moved here) -->
      <div class="px-6 pb-6 sm:px-8 sm:pb-8">
        <button id="closeModalBtn" class="w-full rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-700 px-5 py-3 text-base font-medium">
          ปิด
        </button>
      </div>

      <div class="h-2 bg-gradient-to-r from-indigo-600 to-purple-600"></div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const SHEET_ID = '1Owkrh-v1hYexmOBnuSaYrV6v2352atLazw6HWlUQU84';
    const SHEET_NAME = 'ชีต1';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=out:json`;

    let rowsCache = [];

    // =========================
    // i18n
    // =========================
    const i18n = {
      th: {
        title: 'ข้อมูลการเข้ารับทุนการศึกษา',
        subtitle: 'ค้นหาด้วยรหัสนักศึกษา',
        labelStudentId: 'รหัสนักศึกษา',
        placeholder: 'เช่น 68123456',
        btnSearch: 'ค้นหา',
        note: 'หมายเหตุ: หากไม่พบข้อมูล ระบบจะแจ้ง “ไม่พบข้อมูล กรุณาติดต่อเจ้าหน้าที่”',
        footer: 'พัฒนาโดย ส่วนส่งเสริมและพัฒนานักศึกษา',
        modalTitle: 'ผลการค้นหา',
        close: 'ปิด',
        seat: 'เลขที่นั่ง',
        studentId: 'รหัสนักศึกษา',
        fullName: 'ชื่อ-สกุล',
        scholarship: 'ชื่อทุน',
        loading: 'กำลังโหลดข้อมูล...',
        notLoaded: 'ยังไม่มีข้อมูลสำหรับค้นหา กรุณาตรวจสอบการเชื่อมต่อ',
        fetchError: 'ไม่สามารถดึงข้อมูลจาก Google Sheets ได้ กรุณาตรวจสอบสิทธิ์การเข้าถึง/การเผยแพร่',
        needId: 'กรุณากรอกรหัสนักศึกษา',
        digitsOnly: 'กรุณากรอกเป็นตัวเลขเท่านั้น',
        need8: 'กรุณากรอกรหัสนักศึกษาให้ครบ 8 หลัก',
        notFound: 'ไม่พบข้อมูล กรุณาติดต่อเจ้าหน้าที่',
      },
      en: {
        title: 'Scholarship Attendance Information',
        subtitle: 'Search by student ID',
        labelStudentId: 'Student ID',
        placeholder: 'e.g., 68123456',
        btnSearch: 'Search',
        note: 'Note: If no data is found, the system will show “No data found. Please contact staff.”',
        footer: 'Developed by Division of Student Promotion and Development',
        modalTitle: 'Search Result',
        close: 'Close',
        seat: 'Seat Number',
        studentId: 'Student ID',
        fullName: 'Full Name',
        scholarship: 'Scholarship',
        loading: 'Loading data...',
        notLoaded: 'Data not loaded yet. Please check your connection.',
        fetchError: 'Unable to fetch Google Sheets data. Please check access/sharing or publishing.',
        needId: 'Please enter student ID',
        digitsOnly: 'Digits only, please.',
        need8: 'Please enter an 8-digit student ID',
        notFound: 'No data found. Please contact staff.',
      },
    };

    let lang = localStorage.getItem('lang') || 'th';

    function applyLang() {
      const t = i18n[lang];

      document.documentElement.lang = lang;
      document.title = t.title;

      document.getElementById('title').textContent = t.title;
      document.getElementById('subtitle').textContent = t.subtitle;
      document.getElementById('labelStudentId').textContent = t.labelStudentId;
      document.getElementById('studentId').placeholder = t.placeholder;
      document.getElementById('searchBtn').textContent = t.btnSearch;
      document.getElementById('note').textContent = t.note;
      document.getElementById('footer').textContent = t.footer;

      document.getElementById('modalTitle').textContent = t.modalTitle;
      document.getElementById('closeModalBtn').textContent = t.close;
      document.getElementById('labelSeat').textContent = t.seat;
      document.getElementById('labelStudentIdModal').textContent = t.studentId;
      document.getElementById('labelFullName').textContent = t.fullName;
      document.getElementById('labelScholarship').textContent = t.scholarship;

      document.getElementById('btnTH').classList.toggle('bg-indigo-100', lang === 'th');
      document.getElementById('btnEN').classList.toggle('bg-indigo-100', lang === 'en');
    }

    // Parse GViz JSON
    function parseGvizToArrayObjects(gvizJson) {
      const rows = gvizJson.table.rows || [];
      const data = [];
      for (const r of rows) {
        const c = (r.c || []);
        const studentId = c[0]?.v ?? '';
        const fullName  = c[1]?.v ?? '';
        const seatNo    = c[2]?.v ?? '';
        const fundName  = c[3]?.v ?? '';
        if (!studentId && !fullName && !seatNo && !fundName) continue;
        data.push({
          studentId: String(studentId).trim(),
          fullName: String(fullName).trim(),
          seatNo: String(seatNo).trim(),
          fundName: String(fundName).trim(),
        });
      }
      return data;
    }

    // Load Google Sheet data (no "ready" message shown)
    async function loadSheetData() {
      const statusEl = document.getElementById('status');
      statusEl.classList.remove('text-red-700');
      statusEl.textContent = i18n[lang].loading;

      try {
        const res = await fetch(GVIZ_URL, { cache: 'no-store' });
        const text = await res.text();
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]+)\)\s*;?/);
        if (!match) throw new Error('Bad response format');
        const json = JSON.parse(match[1]);
        rowsCache = parseGvizToArrayObjects(json);
        // Clear status instead of showing "ready" count
        statusEl.textContent = '';
      } catch (err) {
        console.error(err);
        statusEl.classList.add('text-red-700');
        statusEl.textContent = i18n[lang].fetchError;
      }
    }

    // Find by Student ID (exact match)
    function findByStudentId(stdId) {
      const target = String(stdId).trim();
      if (!target) return null;
      return rowsCache.find(r => r.studentId === target) || null;
    }

    // Modal Control
    const modal = {
      el: null,
      backdrop: null,
      open(data) {
        document.getElementById('seatNumber').textContent = data.seatNo || '-';
        document.getElementById('studentIdDisplay').textContent = data.studentId || '-';
        document.getElementById('fullName').textContent = data.fullName || '-';
        document.getElementById('scholarshipName').textContent = data.fundName || '-';

        this.el.classList.remove('hidden');
        this.el.setAttribute('aria-hidden', 'false');
        document.getElementById('closeModalBtn').focus();
      },
      close() {
        this.el.classList.add('hidden');
        this.el.setAttribute('aria-hidden', 'true');
      },
      init() {
        this.el = document.getElementById('resultModal');
        this.backdrop = document.getElementById('modalBackdrop');
        document.getElementById('closeModalBtn').addEventListener('click', () => this.close());
        this.backdrop.addEventListener('click', () => this.close());
        window.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !this.el.classList.contains('hidden')) this.close();
        });
      }
    };

    // Input restrictions (digits only, max 8)
    function attachDigitOnly(input) {
      input.addEventListener('input', () => {
        let v = input.value.replace(/\D/g, '').slice(0, 8);
        input.value = v;
      });
    }

    // Search binding
    function setupSearch() {
      const input = document.getElementById('studentId');
      const btn = document.getElementById('searchBtn');
      const statusEl = document.getElementById('status');

      const doSearch = () => {
        const t = i18n[lang];
        const q = (input.value || '').trim();

        statusEl.classList.remove('text-red-700');

        if (!q) {
          statusEl.textContent = t.needId;
          input.focus();
          return;
        }
        if (!/^\d+$/.test(q)) {
          statusEl.classList.add('text-red-700');
          statusEl.textContent = t.digitsOnly;
          input.focus();
          return;
        }
        if (q.length !== 8) {
          statusEl.classList.add('text-red-700');
          statusEl.textContent = t.need8;
          input.focus();
          return;
        }
        if (!rowsCache.length) {
          statusEl.classList.add('text-red-700');
          statusEl.textContent = t.notLoaded;
          return;
        }

        const found = findByStudentId(q);
        if (!found) {
          statusEl.classList.add('text-red-700');
          statusEl.textContent = t.notFound;
          return;
        }

        statusEl.textContent = '';
        modal.open(found);
      };

      btn.addEventListener('click', doSearch);
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
      attachDigitOnly(input);
    }

    // Language toggle (no "ready" message updates)
    function setupLangToggle() {
      document.getElementById('btnTH').addEventListener('click', () => {
        lang = 'th'; localStorage.setItem('lang', lang); applyLang();
      });
      document.getElementById('btnEN').addEventListener('click', () => {
        lang = 'en'; localStorage.setItem('lang', lang); applyLang();
      });
    }

    // Init
    window.addEventListener('DOMContentLoaded', async () => {
      modal.init();
      setupSearch();
      setupLangToggle();
      applyLang();
      await loadSheetData();
    });
  </script>
</body>
</html>
